<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰¶å°‘é»åç³»çµ± - é›²ç«¯åŒæ­¥ç‰ˆ</title>
    <!-- å¼•å…¥ Google Fonts - Noto Sans TC -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <!-- å¼•å…¥ Phosphor Icons -->
    <link rel="stylesheet" href="https://unpkg.com/@phosphor-icons/web@2.0.3/src/css/icons.css">
    <style>
        /* ä½¿ç”¨è€…æä¾›çš„é¡è‰²æ¿ */
        :root {
            --color-green: #4CAF50; /* åŸå§‹æˆåŠŸç¶  */
            --color-yellow: #D9AC5A; /* è«‹å‡é»ƒ */
            --color-blue: #5F8FA7; /* é»åçµæœè— */
            --color-orange: #E26448; /* ç¼ºå¸­/å±éšªæ©˜ */
            --color-cream: #F2EFE7; /* èƒŒæ™¯å¥¶æ²¹è‰² */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: var(--color-cream);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(5px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #83aa87, #729175);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        
        .footer {
            padding: 10px;
            text-align: center;
            font-size: 0.8em;
            color: #888;
            background: rgba(255, 255, 255, 0.5);
        }

        .header-main-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .header h1 {
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin: 0;
        }
        
        .header .btn-settings {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.5em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header .btn-settings:hover {
            transform: rotate(90deg);
            background: rgba(255, 255, 255, 0.4);
        }

        .week-info {
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 1.1em;
            display: inline-block;
        }
        
        .header-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .header-actions .btn {
            font-size: 1.2em;
        }

        .content {
            padding: 30px;
        }

        .student-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, 200px);
            gap: 20px;
            margin-top: 20px;
            justify-content: center;
        }

        .student-card {
            background: linear-gradient(145deg, #ffffff, #f0f0f0);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
            width: 200px;
            height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .student-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.5), transparent);
            transition: left 0.5s;
        }

        .student-card:hover::before {
            left: 100%;
        }

        .student-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 15px 30px rgba(0,0,0,0.2);
        }

        .student-card.present {
            background: linear-gradient(145deg, #e3f2e4, #d3e9d5);
            border-color: var(--color-green);
            color: var(--color-green);
        }

        .student-card.absent {
            background: linear-gradient(145deg, #f9e2e2, #f1c7c7);
            border-color: var(--color-orange);
            color: var(--color-orange);
        }

        .student-card.on-leave {
            background: linear-gradient(145deg, #fefce7, #fdf8c9);
            border-color: var(--color-yellow);
            color: var(--color-yellow);
        }

        .student-name {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .student-status {
            font-size: 0.9em;
            padding: 5px 10px;
            border-radius: 15px;
            background: rgba(255,255,255,0.3);
            display: inline-block;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(145deg, #ffffff, #f0f0f0);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #333;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        input[type="text"], select, textarea {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            min-width: 200px;
        }

        input[type="text"]:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--color-green);
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            animation: slideDown 0.3s ease;
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes slideDown {
            from { transform: translateY(-50px) scale(0.95); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            z-index: 2000;
            transform: translateX(120%);
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: linear-gradient(45deg, var(--color-green), #45a049);
        }

        .notification.error {
            background: linear-gradient(45deg, var(--color-orange), #a74e3a);
        }
        
        h3 {
            margin-top: 20px;
            margin-bottom: 10px;
            color: var(--color-green);
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            white-space: nowrap;
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--color-green), #45a049);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(45deg, var(--color-yellow), #c09a47);
            color: white;
        }

        .btn-purple {
            background: linear-gradient(45deg, var(--color-blue), #4c7b8c);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(45deg, var(--color-orange), #a74e3a);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .results-list {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            word-break: break-word;
        }

        .results-list-present { background: rgba(76, 175, 80, 0.1); color: var(--color-green); }
        .results-list-absent { background: rgba(226, 100, 72, 0.1); color: var(--color-orange); }
        .results-list-on-leave { background: rgba(217, 172, 90, 0.1); color: var(--color-yellow); }

        .firebase-config {
            background: rgba(95, 143, 167, 0.1);
            border-left: 4px solid var(--color-blue);
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
        }

        .firebase-config textarea {
            width: 100%;
            height: 150px;
            font-family: monospace;
            font-size: 0.9em;
        }

        .connection-status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            margin-left: 10px;
        }

        .connected {
    /* èª¿æ•´èƒŒæ™¯è‰²ï¼Œä½¿å…¶æ›´ç‚ºé£½å’Œ */
    background: #4CAF50; /* ç›´æ¥ä½¿ç”¨ç¶ è‰²è®Šæ•¸ */
    /* è®“æ–‡å­—é¡è‰²ä¿æŒç™½è‰²ä»¥å¢åŠ å°æ¯” */
    color: white; 
    /* å¢åŠ é™°å½±æ•ˆæœ */
    box-shadow: 0 2px 4px rgba(0, 100, 0, 0.2); 
}

/* å¯ä»¥ç‚ºæ»‘é¼ æ‡¸åœæ™‚å¢åŠ å‹•ç•«æ•ˆæœ */
.connected:hover {
    transform: scale(1.05);
}

        .disconnected {
            background: rgba(226, 100, 72, 0.2);
            color: var(--color-orange);
        }

        .connecting {
            background: rgba(217, 172, 90, 0.2);
            color: var(--color-yellow);
        }

        @media (max-width: 768px) {
            body { padding: 10px; }
            .header h1 { font-size: 2em; }
            .student-grid { grid-template-columns: repeat(auto-fill, 200px); gap: 15px; }
            .input-group { flex-direction: column; }
            .header .btn-settings { position: static; margin-top: 10px; width: 40px; height: 40px; font-size: 1.2em; }
            .header-main-row { flex-direction: column; }
            .header-actions { flex-direction: column; }
            .modal-content { width: 95%; padding: 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-main-row">
                <h1>æ‰¶å°‘é»åç³»çµ±</h1>
                <div class="week-info">
                    <span id="currentDate"></span>
                    <span id="connectionStatus" class="connection-status connecting">é€£æ¥ä¸­...</span>
                </div>
            </div>

            <div class="header-actions">
                <button class="btn btn-warning" id="leaveModeBtn" onclick="toggleLeaveMode()">æ¨™è¨˜è«‹å‡</button>
                <button class="btn btn-purple" onclick="showResults()">é»åçµæœ</button>
            </div>
            
            <button class="btn-settings" onclick="showModal('settingsModal')">âš™ï¸</button>
        </div>
        
        <div class="content">
            <div class="student-grid" id="studentGrid">
                <p>æ­£åœ¨é€£æ¥é›²ç«¯è³‡æ–™åº«...</p>
            </div>
        </div>
        
        <div class="footer">
            â˜ï¸ é›²ç«¯å³æ™‚åŒæ­¥ | æ‰€æœ‰è£ç½®è³‡æ–™è‡ªå‹•åŒæ­¥
        </div>
    </div>

    <!-- Firebase è¨­å®šæ¨¡æ…‹æ¡† -->
    <div id="configModal" class="modal">
        <div class="modal-content">
            <h2>ğŸ”¥ Firebase è¨­å®š</h2>
            <p style="color: #666; margin-bottom: 15px;">
                è«‹åœ¨ä¸‹æ–¹è²¼ä¸Šæ‚¨çš„ Firebase è¨­å®šè³‡è¨Šã€‚è¨­å®šå®Œæˆå¾Œï¼Œæ‰€æœ‰è£ç½®çš„è³‡æ–™å°‡æœƒè‡ªå‹•åŒæ­¥ã€‚
            </p>
            
            <div class="firebase-config">
                <h4>Firebase è¨­å®š JSON</h4>
                <textarea id="firebaseConfig" placeholder='{
"apiKey": "your-api-key",
"authDomain": "your-project.firebaseapp.com",
"projectId": "your-project-id",
"storageBucket": "your-project.appspot.com",
"messagingSenderId": "123456789",
"appId": "your-app-id"
}'></textarea>
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button class="btn btn-primary" onclick="saveFirebaseConfig()">å„²å­˜è¨­å®š</button>
                <button class="btn btn-danger" onclick="useOfflineMode()">é›¢ç·šæ¨¡å¼</button>
            </div>
            
            <div style="margin-top: 20px; font-size: 0.9em; color: #666;">
                <h4>å¦‚ä½•å–å¾— Firebase è¨­å®šï¼Ÿ</h4>
                <ol>
                    <li>åˆ° <a href="https://console.firebase.google.com/" target="_blank">Firebase Console</a></li>
                    <li>å»ºç«‹æ–°å°ˆæ¡ˆæˆ–é¸æ“‡ç¾æœ‰å°ˆæ¡ˆ</li>
                    <li>å•Ÿç”¨ Firestore è³‡æ–™åº«ï¼ˆæ¸¬è©¦æ¨¡å¼ï¼‰</li>
                    <li>åˆ°å°ˆæ¡ˆè¨­å®š â†’ æ‡‰ç”¨ç¨‹å¼ â†’ ç¶²é æ‡‰ç”¨ç¨‹å¼</li>
                    <li>è¤‡è£½è¨­å®šç‰©ä»¶ä¸¦è²¼åˆ°ä¸Šæ–¹</li>
                </ol>
            </div>
        </div>
    </div>

    <!-- è¨­å®šæ¨¡æ…‹æ¡† -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('settingsModal')">&times;</span>
            <h2><i class="ph-fill ph-gear-six"></i> è¨­å®š</h2>
            <div class="settings-grid">
                <button class="btn btn-primary" onclick="showManagementModal()">å­¸ç”Ÿç®¡ç†</button>
                <button class="btn btn-purple" onclick="showModal('configModal')">Firebase è¨­å®š</button>
                <button class="btn btn-danger" onclick="resetAllData()">é‡è¨­æ•´å€‹ç³»çµ±</button>
            </div>
        </div>
    </div>

    <!-- å­¸ç”Ÿç®¡ç†æ¨¡æ…‹æ¡† -->
    <div id="managementModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('managementModal')">&times;</span>
            <h2><i class="ph-fill ph-users"></i> å­¸ç”Ÿç®¡ç†</h2>
            
            <p style="color: #666; margin-bottom: 15px;">æ–°å¢ã€ç§»é™¤æˆ–æ‰¹é‡æ–°å¢å­¸ç”Ÿã€‚æ‰€æœ‰æ›´å‹•å°‡å³æ™‚åŒæ­¥çµ¦åœ˜éšŠæˆå“¡ã€‚</p>
            
            <div class="input-group">
                <input type="text" id="newStudentName" placeholder="è¼¸å…¥å­¸ç”Ÿå§“å">
                <button class="btn btn-primary" onclick="addStudent()">æ–°å¢</button>
            </div>
            
            <h4 style="margin-top: 20px;">æ‰¹é‡æ–°å¢ï¼ˆæ¯è¡Œä¸€å€‹å§“åï¼‰</h4>
            <textarea id="bulkStudents" placeholder="å¼µå°æ˜&#10;æå°è¯&#10;ç‹å°ç¾" style="width: 100%; height: 120px; padding: 10px; border: 2px solid #ddd; border-radius: 8px; margin-bottom: 10px;"></textarea>
            <button class="btn btn-primary" onclick="addBulkStudents()">æ‰¹é‡æ–°å¢</button>
            
            <h4 style="margin-top: 20px;">ç§»é™¤å­¸ç”Ÿ</h4>
            <div class="input-group">
                <select id="removeStudentSelect" style="flex: 1; min-width: 200px;">
                    <option value="">é¸æ“‡è¦ç§»é™¤çš„å­¸ç”Ÿ</option>
                </select>
                <button class="btn btn-danger" onclick="removeStudent()">ç§»é™¤</button>
            </div>
        </div>
    </div>

    <!-- é»åçµæœæ¨¡æ…‹æ¡† -->
    <div id="resultsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('resultsModal')">&times;</span>
            <h2>ğŸ“Š é»åçµæœ</h2>
            <div id="resultsContent"></div>
        </div>
    </div>

    <!-- é€šçŸ¥è¨Šæ¯ -->
    <div id="notification" class="notification"></div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, writeBatch, collection, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- å…¨åŸŸè®Šæ•¸ ---
        let students = [];
        let attendanceHistory = {};
        let leaveMode = false;
        let isOnline = false;
        let db = null;
        
        const currentDateKey = new Date().toISOString().split('T')[0];
        const STORAGE_KEY = 'attendanceSystem_firebaseConfig';

        // é è¨­çš„ Firebase è¨­å®š
        const defaultFirebaseConfig = {
            apiKey: "AIzaSyB4n7tnjJhyI9cmxpjnqbWMfrjDOYIrA3U",
            authDomain: "attendance-check-60081.firebaseapp.com",
            projectId: "attendance-check-60081",
            storageBucket: "attendance-check-60081.firebasestorage.app",
            messagingSenderId: "33068227665",
            appId: "1:33068227665:web:dba6f037b27c9aabc22c70",
            measurementId: "G-PLSZCJTTCF"
        };

        // --- Firebase åˆå§‹åŒ– ---
        async function initFirebase() {
            let firebaseConfig = null;
            const savedConfig = localStorage.getItem(STORAGE_KEY);
            
            if (savedConfig) {
                try {
                    firebaseConfig = JSON.parse(savedConfig);
                } catch (error) {
                    console.error('è§£æå„²å­˜çš„è¨­å®šå¤±æ•—:', error);
                }
            }
            
            // å¦‚æœæ²’æœ‰å„²å­˜çš„è¨­å®šï¼Œä½¿ç”¨é è¨­è¨­å®š
            if (!firebaseConfig) {
                firebaseConfig = defaultFirebaseConfig;
                localStorage.setItem(STORAGE_KEY, JSON.stringify(firebaseConfig));
                showNotification('ä½¿ç”¨é è¨­ Firebase è¨­å®š', 'success');
            }

            try {
                console.log('æ­£åœ¨åˆå§‹åŒ– Firebase...', firebaseConfig.projectId);
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                
                // æ¸¬è©¦é€£æ¥ä¸¦åˆå§‹åŒ–è³‡æ–™
                await initializeData();
                setupRealtimeListeners();
                updateConnectionStatus('connected');
                showNotification('Firebase é€£æ¥æˆåŠŸï¼', 'success');
                return true;
            } catch (error) {
                console.error('Firebase åˆå§‹åŒ–å¤±æ•—:', error);
                updateConnectionStatus('disconnected');
                showNotification(`é€£æ¥å¤±æ•—: ${error.message}`, 'error');
                loadOfflineData();
                return false;
            }
        }

        async function initializeData() {
            try {
                // åˆå§‹åŒ–å­¸ç”Ÿåå–®
                const studentsRef = doc(db, 'attendance-system', 'students');
                const studentsSnap = await getDoc(studentsRef);
                
                if (!studentsSnap.exists()) {
                    console.log('åˆå§‹åŒ–å­¸ç”Ÿåå–®...');
                    await setDoc(studentsRef, { 
                        list: [],
                        created: new Date().toISOString(),
                        lastUpdated: new Date().toISOString()
                    });
                }

                // åˆå§‹åŒ–ä»Šæ—¥å‡ºå‹¤è¨˜éŒ„
                const attendanceRef = doc(db, 'attendance-system', currentDateKey);
                const attendanceSnap = await getDoc(attendanceRef);
                
                if (!attendanceSnap.exists()) {
                    console.log('åˆå§‹åŒ–ä»Šæ—¥å‡ºå‹¤è¨˜éŒ„...');
                    await setDoc(attendanceRef, { 
                        records: {},
                        date: currentDateKey,
                        created: new Date().toISOString()
                    });
                }

                console.log('Firebase è³‡æ–™åˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                console.error('è³‡æ–™åˆå§‹åŒ–å¤±æ•—:', error);
                throw error;
            }
        }

        function setupRealtimeListeners() {
            console.log('è¨­ç½®å³æ™‚ç›£è½å™¨...');
            
            // ç›£è½å­¸ç”Ÿåå–®
            const studentsRef = doc(db, 'attendance-system', 'students');
            onSnapshot(studentsRef, (docSnap) => {
                console.log('å­¸ç”Ÿåå–®æ›´æ–°');
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    students = data.list || [];
                } else {
                    students = [];
                }
                renderAll();
                updateRemoveStudentSelect();
            }, (error) => {
                console.error('å­¸ç”Ÿåå–®ç›£è½å¤±æ•—:', error);
                updateConnectionStatus('disconnected');
                showNotification('åŒæ­¥ä¸­æ–·ï¼Œåˆ‡æ›åˆ°é›¢ç·šæ¨¡å¼', 'error');
                loadOfflineData();
            });

            // ç›£è½ä»Šæ—¥å‡ºå‹¤
            const attendanceRef = doc(db, 'attendance-system', currentDateKey);
            onSnapshot(attendanceRef, (docSnap) => {
                console.log('å‡ºå‹¤è¨˜éŒ„æ›´æ–°');
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    attendanceHistory[currentDateKey] = data.records || {};
                } else {
                    attendanceHistory[currentDateKey] = {};
                }
                renderAll();
            }, (error) => {
                console.error('å‡ºå‹¤è¨˜éŒ„ç›£è½å¤±æ•—:', error);
                updateConnectionStatus('disconnected');
                showNotification('åŒæ­¥ä¸­æ–·ï¼Œåˆ‡æ›åˆ°é›¢ç·šæ¨¡å¼', 'error');
            });
        }

        // --- UI å‡½å¼ ---
        function updateConnectionStatus(status) {
            const statusElement = document.getElementById('connectionStatus');
            statusElement.className = `connection-status ${status}`;
            
            switch(status) {
                case 'connected':
                    statusElement.textContent = 'â˜ï¸ å·²é€£æ¥';
                    isOnline = true;
                    break;
                case 'connecting':
                    statusElement.textContent = 'ğŸ”„ é€£æ¥ä¸­';
                    isOnline = false;
                    break;
                case 'disconnected':
                    statusElement.textContent = 'âŒ é›¢ç·š';
                    isOnline = false;
                    break;
            }
        }

        window.saveFirebaseConfig = async () => {
            const configText = document.getElementById('firebaseConfig').value.trim();
            if (!configText) {
                showNotification('è«‹è¼¸å…¥ Firebase è¨­å®š', 'error');
                return;
            }

            try {
                const config = JSON.parse(configText);
                if (!config.apiKey || !config.projectId) {
                    throw new Error('è¨­å®šæ ¼å¼ä¸æ­£ç¢º');
                }
                
                localStorage.setItem(STORAGE_KEY, JSON.stringify(config));
                closeModal('configModal');
                showNotification('è¨­å®šå·²å„²å­˜ï¼Œæ­£åœ¨é€£æ¥...', 'success');
                
                // é‡æ–°è¼‰å…¥é é¢ä»¥å¥—ç”¨æ–°è¨­å®š
                setTimeout(() => location.reload(), 1000);
            } catch (error) {
                showNotification('è¨­å®šæ ¼å¼éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ JSON æ ¼å¼', 'error');
            }
        };

        window.useOfflineMode = () => {
            localStorage.removeItem(STORAGE_KEY);
            closeModal('configModal');
            showNotification('ä½¿ç”¨é›¢ç·šæ¨¡å¼', 'success');
            loadOfflineData();
            renderAll();
        };

        // --- è³‡æ–™æ“ä½œå‡½å¼ ---
        async function updateStudentList(newStudents) {
            if (isOnline) {
                try {
                    const studentsRef = doc(db, 'attendance-system', 'students');
                    await setDoc(studentsRef, { list: newStudents });
                } catch (error) {
                    console.error('æ›´æ–°å­¸ç”Ÿåå–®å¤±æ•—:', error);
                    showNotification('åŒæ­¥å¤±æ•—', 'error');
                }
            } else {
                students = newStudents;
                saveOfflineData();
                renderAll();
                updateRemoveStudentSelect();
            }
        }

        async function updateAttendance(studentName, status) {
            if (isOnline) {
                try {
                    const attendanceRef = doc(db, 'attendance-system', currentDateKey);
                    const updateData = {};
                    
                    if (status === null) {
                        // ç§»é™¤è¨˜éŒ„
                        const currentData = attendanceHistory[currentDateKey] || {};
                        delete currentData[studentName];
                        await setDoc(attendanceRef, { records: currentData });
                    } else {
                        updateData[`records.${studentName}`] = status;
                        await updateDoc(attendanceRef, updateData);
                    }
                } catch (error) {
                    console.error('æ›´æ–°å‡ºå‹¤è¨˜éŒ„å¤±æ•—:', error);
                    showNotification('åŒæ­¥å¤±æ•—', 'error');
                }
            } else {
                if (status === null) {
                    delete attendanceHistory[currentDateKey][studentName];
                } else {
                    attendanceHistory[currentDateKey][studentName] = status;
                }
                saveOfflineData();
                renderAll();
            }
        }

        // --- é›¢ç·šè³‡æ–™è™•ç† ---
        function loadOfflineData() {
            const savedStudents = localStorage.getItem('offline_students');
            const savedAttendance = localStorage.getItem('offline_attendance');
            
            students = savedStudents ? JSON.parse(savedStudents) : [];
            attendanceHistory = savedAttendance ? JSON.parse(savedAttendance) : {};
            
            if (!attendanceHistory[currentDateKey]) {
                attendanceHistory[currentDateKey] = {};
            }

            // --- æ–°å¢ï¼šè™•ç†é›¢ç·šæ¨¡å¼ä¸‹çš„èˆŠç´€éŒ„åˆªé™¤ ---
            const twoDaysAgo = new Date();
            twoDaysAgo.setDate(twoDaysAgo.getDate() - 2);
            const twoDaysAgoStr = twoDaysAgo.toISOString().split('T')[0];

            for (const date in attendanceHistory) {
                if (date < twoDaysAgoStr) {
                    delete attendanceHistory[date];
                    console.log(`é›¢ç·šæ¨¡å¼ï¼šå·²åˆªé™¤éæœŸè¨˜éŒ„ ${date}`);
                }
            }
            saveOfflineData();
            // --- çµæŸæ–°å¢ ---
            
            updateRemoveStudentSelect();
        }

        function saveOfflineData() {
            localStorage.setItem('offline_students', JSON.stringify(students));
            localStorage.setItem('offline_attendance', JSON.stringify(attendanceHistory));
        }

        // --- ä¸»è¦åŠŸèƒ½å‡½å¼ ---
        window.toggleAttendance = async (studentName) => {
            const attendance = getCurrentAttendance();
            let newStatus;
            
            if (leaveMode) {
                newStatus = attendance[studentName] === 'on-leave' ? null : 'on-leave';
            } else {
                if (attendance[studentName] === 'on-leave') {
                    showNotification(`${studentName} å·²è«‹å‡ï¼Œç„¡æ³•é»å`, 'error');
                    return;
                }
                newStatus = attendance[studentName] === 'present' ? null : 'present';
            }

            // æ›´æ–°æœ¬åœ°è³‡æ–™
            if (newStatus) {
                attendanceHistory[currentDateKey][studentName] = newStatus;
            } else {
                delete attendanceHistory[currentDateKey][studentName];
            }

            // åŒæ­¥åˆ°é›²ç«¯æˆ–å„²å­˜åˆ°æœ¬åœ°
            await updateAttendance(studentName, newStatus);
            
            // å³æ™‚æ›´æ–° UI
            if (!isOnline) {
                renderAll();
            }
        };

        window.toggleLeaveMode = () => {
            leaveMode = !leaveMode;
            const btn = document.getElementById('leaveModeBtn');
            if (leaveMode) {
                btn.textContent = 'é»åæ¨¡å¼';
                btn.className = 'btn btn-primary';
                showNotification('å·²åˆ‡æ›åˆ°è«‹å‡æ¨¡å¼', 'success');
            } else {
                btn.textContent = 'æ¨™è¨˜è«‹å‡';
                btn.className = 'btn btn-warning';
                showNotification('å·²åˆ‡æ›åˆ°é»åæ¨¡å¼', 'success');
            }
        };

        window.addStudent = async () => {
            const nameInput = document.getElementById('newStudentName');
            const name = nameInput.value.trim();
            
            if (!name) {
                showNotification('è«‹è¼¸å…¥å­¸ç”Ÿå§“å', 'error');
                return;
            }
            
            if (students.includes(name)) {
                showNotification('å­¸ç”Ÿå·²å­˜åœ¨', 'error');
                return;
            }
            
            const newStudents = [...students, name];
            await updateStudentList(newStudents);
            nameInput.value = '';
            showNotification(`å·²æ–°å¢å­¸ç”Ÿï¼š${name}`, 'success');
        };

        window.addBulkStudents = async () => {
            const bulkText = document.getElementById('bulkStudents').value.trim();
            if (!bulkText) {
                showNotification('è«‹è¼¸å…¥å­¸ç”Ÿå§“å', 'error');
                return;
            }
            
            const names = bulkText.split('\n').map(name => name.trim()).filter(name => name);
            const newNames = names.filter(name => !students.includes(name));
            
            if (newNames.length === 0) {
                showNotification('æ²’æœ‰æ–°çš„å­¸ç”Ÿéœ€è¦æ–°å¢', 'error');
                return;
            }
            
            const newStudents = [...students, ...newNames];
            await updateStudentList(newStudents);
            document.getElementById('bulkStudents').value = '';
            showNotification(`å·²æ‰¹é‡æ–°å¢ ${newNames.length} åå­¸ç”Ÿ`, 'success');
        };

        window.removeStudent = async () => {
            const select = document.getElementById('removeStudentSelect');
            const studentName = select.value;
            
            if (!studentName) {
                showNotification('è«‹é¸æ“‡è¦ç§»é™¤çš„å­¸ç”Ÿ', 'error');
                return;
            }
            
            if (confirm(`ç¢ºå®šè¦ç§»é™¤å­¸ç”Ÿã€Œ${studentName}ã€å—ï¼Ÿ`)) {
                const newStudents = students.filter(name => name !== studentName);
                await updateStudentList(newStudents);
                
                // åŒæ™‚ç§»é™¤è©²å­¸ç”Ÿçš„å‡ºå‹¤è¨˜éŒ„
                if (attendanceHistory[currentDateKey][studentName]) {
                    await updateAttendance(studentName, null);
                }
                
                showNotification(`å·²ç§»é™¤å­¸ç”Ÿï¼š${studentName}`, 'success');
            }
        };

        window.resetAttendance = async () => {
            if (confirm('ç¢ºå®šè¦é‡ç½®ä»Šæ—¥çš„é»åè¨˜éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) {
                attendanceHistory[currentDateKey] = {};
                
                if (isOnline) {
                    const attendanceRef = doc(db, 'attendance-system', currentDateKey);
                    await setDoc(attendanceRef, { records: {} });
                } else {
                    saveOfflineData();
                    renderAll();
                }
                
                showNotification('ä»Šæ—¥é»åè¨˜éŒ„å·²é‡ç½®', 'success');
            }
        };

        // --- æ–°å¢çš„å‡½å¼ï¼šé‡è¨­æ‰€æœ‰è³‡æ–™ ---
        window.resetAllData = async () => {
            if (!confirm('ğŸš¨ è­¦å‘Šï¼šæ­¤æ“ä½œå°‡æ°¸ä¹…åˆªé™¤æ‰€æœ‰å­¸ç”Ÿåå–®åŠé»åè¨˜éŒ„ï¼æ‚¨ç¢ºå®šè¦é‡è¨­æ•´å€‹ç³»çµ±å—ï¼Ÿ')) {
                return; // å¦‚æœä½¿ç”¨è€…å–æ¶ˆï¼Œå‰‡ä¸åšä»»ä½•äº‹
            }

            // æ¸…é™¤æœ¬åœ°è³‡æ–™
            students = [];
            attendanceHistory = {};

            if (isOnline) {
                try {
                    const batch = writeBatch(db);
                    const attendanceCollection = collection(db, 'attendance-system');
                    const querySnapshot = await getDocs(attendanceCollection);
                    
                    querySnapshot.forEach((docSnap) => {
                        // åˆªé™¤æ‰€æœ‰ documentï¼ŒåŒ…æ‹¬å­¸ç”Ÿåå–®
                        const docRef = doc(db, 'attendance-system', docSnap.id);
                        batch.delete(docRef);
                    });
                    
                    await batch.commit();
                    showNotification('ç³»çµ±å·²é‡è¨­ï¼æ­£åœ¨é‡æ–°æ•´ç†...', 'success');
                    // ç­‰å¾… Firebase åŒæ­¥ï¼Œç„¶å¾Œé‡æ–°è¼‰å…¥
                    setTimeout(() => location.reload(), 1500);

                } catch (error) {
                    console.error('é‡è¨­è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                    showNotification('é‡è¨­å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š', 'error');
                }
            } else {
                // é›¢ç·šæ¨¡å¼
                saveOfflineData();
                showNotification('é›¢ç·šæ¨¡å¼å·²é‡è¨­æ‰€æœ‰è³‡æ–™ï¼æ­£åœ¨é‡æ–°æ•´ç†...', 'success');
                setTimeout(() => location.reload(), 1500);
            }
        };
        // --- çµæŸæ–°å¢ ---

        // --- è¼”åŠ©å‡½å¼ ---
        function getCurrentAttendance() {
            return attendanceHistory[currentDateKey] || {};
        }

        function updateRemoveStudentSelect() {
            const select = document.getElementById('removeStudentSelect');
            select.innerHTML = '<option value="">é¸æ“‡è¦ç§»é™¤çš„å­¸ç”Ÿ</option>';
            
            students.forEach(student => {
                const option = document.createElement('option');
                option.value = student;
                option.textContent = student;
                select.appendChild(option);
            });
        }

        function renderAll() {
            renderStudents();
            updateCurrentDate();
        }

        function renderStudents() {
            const grid = document.getElementById('studentGrid');
            const attendance = getCurrentAttendance();
            
            if (students.length === 0) {
                grid.innerHTML = '<p style="text-align: center; color: #666;">å°šæœªæ–°å¢ä»»ä½•å­¸ç”Ÿï¼Œè«‹åˆ°è¨­å®šä¸­æ–°å¢å­¸ç”Ÿã€‚</p>';
                return;
            }
            
            grid.innerHTML = students.map(student => {
                const status = attendance[student] || 'not-marked';
                const statusText = {
                    'present': 'âœ… å‡ºå¸­',
                    'on-leave': 'è«‹å‡',
                    'not-marked': 'âŒ æœªé»å'
                };
                
                return `
                    <div class="student-card ${status}" onclick="toggleAttendance('${student}')">
                        <div class="student-name">${student}</div>
                        <div class="student-status">${statusText[status]}</div>
                    </div>
                `;
            }).join('');
        }

        function updateCurrentDate() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('zh-TW', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                weekday: 'long'
            });
            document.getElementById('currentDate').textContent = dateStr;
        }

        // --- æ¨¡æ…‹æ¡†å‡½å¼ ---
        window.showModal = (modalId) => {
            document.getElementById(modalId).style.display = 'flex';
            
            if (modalId === 'managementModal') {
                updateRemoveStudentSelect();
            } else if (modalId === 'configModal') {
                const savedConfig = localStorage.getItem(STORAGE_KEY);
                if (savedConfig) {
                    document.getElementById('firebaseConfig').value = JSON.stringify(JSON.parse(savedConfig), null, 2);
                }
            }
        };

        window.closeModal = (modalId) => {
            document.getElementById(modalId).style.display = 'none';
        };

        window.showManagementModal = () => {
            closeModal('settingsModal');
            showModal('managementModal');
        };

        window.showResults = () => {
            const attendance = getCurrentAttendance();
            const present = students.filter(student => attendance[student] === 'present');
            const onLeave = students.filter(student => attendance[student] === 'on-leave');
            const absent = students.filter(student => !attendance[student] || attendance[student] === 'not-marked');
            
            const resultsContent = document.getElementById('resultsContent');
            resultsContent.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <strong>é»åæ—¥æœŸï¼š</strong>${new Date().toLocaleDateString('zh-TW')}
                </div>
                
                <div class="results-list results-list-present">
                    <strong>å‡ºå¸­ (${present.length}äºº)ï¼š</strong><br>
                    ${present.length > 0 ? present.join('ã€') : 'ç„¡'}
                </div>
                
                <div class="results-list results-list-absent">
                    <strong>ç¼ºå¸­ (${absent.length}äºº)ï¼š</strong><br>
                    ${absent.length > 0 ? absent.join('ã€') : 'ç„¡'}
                </div>
                
                <div class="results-list results-list-on-leave">
                    <strong>è«‹å‡ (${onLeave.length}äºº)ï¼š</strong><br>
                    ${onLeave.length > 0 ? onLeave.join('ã€') : 'ç„¡'}
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 8px;">
                    <strong>çµ±è¨ˆæ‘˜è¦ï¼š</strong><br>
                    ç¸½äººæ•¸ï¼š${students.length}äºº<br>
                    å‡ºå¸­ç‡ï¼š${students.length > 0 ? Math.round((present.length / students.length) * 100) : 0}%
                </div>
            `;
            
            showModal('resultsModal');
        };

        // --- é€šçŸ¥å‡½å¼ ---
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            
            // è§¸ç™¼é¡¯ç¤ºå‹•ç•«
            setTimeout(() => notification.classList.add('show'), 100);
            
            // 3ç§’å¾Œéš±è—
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // --- æ–°å¢å‡½å¼ï¼šè‡ªå‹•æ¸…é™¤èˆŠçš„é»åè¨˜éŒ„ ---
        async function cleanupOldAttendance() {
            console.log('æ­£åœ¨æª¢æŸ¥ä¸¦æ¸…é™¤èˆŠçš„é»åè¨˜éŒ„...');
            const twoDaysAgo = new Date();
            twoDaysAgo.setDate(twoDaysAgo.getDate() - 2);
            const twoDaysAgoStr = twoDaysAgo.toISOString().split('T')[0];

            if (isOnline && db) {
                try {
                    const attendanceCollection = collection(db, 'attendance-system');
                    const querySnapshot = await getDocs(attendanceCollection);
                    const batch = writeBatch(db);
                    let deletedCount = 0;
                    
                    querySnapshot.forEach((docSnap) => {
                        // æ’é™¤å­¸ç”Ÿåå–® document
                        if (docSnap.id !== 'students') {
                            const docDate = docSnap.id;
                            if (docDate < twoDaysAgoStr) {
                                const docRef = doc(db, 'attendance-system', docDate);
                                batch.delete(docRef);
                                deletedCount++;
                                console.log(`Firebaseï¼šæº–å‚™åˆªé™¤éæœŸè¨˜éŒ„ ${docDate}`);
                            }
                        }
                    });
                    
                    if (deletedCount > 0) {
                        await batch.commit();
                        showNotification(`å·²è‡ªå‹•æ¸…é™¤ ${deletedCount} ç­†éæœŸé»åè¨˜éŒ„`, 'success');
                    }
                } catch (error) {
                    console.error('æ¸…é™¤èˆŠè¨˜éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                    showNotification('æ¸…é™¤èˆŠè¨˜éŒ„å¤±æ•—', 'error');
                }
            } else {
                // é›¢ç·šæ¨¡å¼çš„æ¸…ç†é‚è¼¯å·²åœ¨ loadOfflineData å‡½å¼ä¸­è™•ç†
                console.log('é›¢ç·šæ¨¡å¼ï¼Œè¨˜éŒ„æ¸…ç†å·²åœ¨è¼‰å…¥æ™‚å®Œæˆ');
            }
        }
        // --- çµæŸæ–°å¢ ---

        // --- äº‹ä»¶ç›£è½å™¨ ---
        document.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const target = e.target;
                if (target.id === 'newStudentName') {
                    addStudent();
                }
            }
        });

        // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                const modalId = e.target.id;
                if (modalId !== 'configModal') { // é…ç½®æ¨¡æ…‹æ¡†ä¸å…è¨±é»æ“Šå¤–éƒ¨é—œé–‰
                    closeModal(modalId);
                }
            }
        });

        // --- åˆå§‹åŒ– ---
        async function initialize() {
            console.log('ç³»çµ±åˆå§‹åŒ–é–‹å§‹...');
            updateCurrentDate();
            updateConnectionStatus('connecting');
            
            try {
                const firebaseReady = await initFirebase();
                
                if (firebaseReady) {
                    // --- åœ¨é€£æ¥æˆåŠŸå¾Œï¼ŒåŸ·è¡Œæ¸…ç†èˆŠè¨˜éŒ„çš„å‹•ä½œ ---
                    await cleanupOldAttendance();
                    // --- çµæŸæ–°å¢ ---
                } else {
                    console.log('Firebase é€£æ¥å¤±æ•—ï¼Œè¼‰å…¥é›¢ç·šè³‡æ–™');
                    loadOfflineData();
                }
                renderAll();
            } catch (error) {
                console.error('åˆå§‹åŒ–éŒ¯èª¤:', error);
                updateConnectionStatus('disconnected');
                showNotification('åˆå§‹åŒ–å¤±æ•—ï¼Œä½¿ç”¨é›¢ç·šæ¨¡å¼', 'error');
                loadOfflineData();
                renderAll();
            }
        }

        // å•Ÿå‹•æ‡‰ç”¨
        initialize();
    </script>
</body>
</html>
