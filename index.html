<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>扶少點名系統 - 雲端同步版</title>
    <!-- 引入 Google Fonts - Noto Sans TC -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <!-- 引入 Phosphor Icons -->
    <link rel="stylesheet" href="https://unpkg.com/@phosphor-icons/web@2.0.3/src/css/icons.css">
    <style>
        /* 使用者提供的顏色板 */
        :root {
            --color-green: #4CAF50; /* 原始成功綠 */
            --color-yellow: #D9AC5A; /* 請假黃 */
            --color-blue: #5F8FA7; /* 點名結果藍 */
            --color-orange: #E26448; /* 缺席/危險橘 */
            --color-cream: #F2EFE7; /* 背景奶油色 */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: var(--color-cream);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(5px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #83aa87, #729175);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        
        .footer {
            padding: 10px;
            text-align: center;
            font-size: 0.8em;
            color: #888;
            background: rgba(255, 255, 255, 0.5);
        }

        .header-main-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .header h1 {
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin: 0;
        }
        
        .header .btn-settings {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.5em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header .btn-settings:hover {
            transform: rotate(90deg);
            background: rgba(255, 255, 255, 0.4);
        }

        .week-info {
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 1.1em;
            display: inline-block;
        }
        
        .header-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .header-actions .btn {
            font-size: 1.2em;
        }

        .content {
            padding: 30px;
        }

        .student-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, 200px);
            gap: 20px;
            margin-top: 20px;
            justify-content: center;
        }

        .student-card {
            background: linear-gradient(145deg, #ffffff, #f0f0f0);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
            width: 200px;
            height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .student-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.5), transparent);
            transition: left 0.5s;
        }

        .student-card:hover::before {
            left: 100%;
        }

        .student-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 15px 30px rgba(0,0,0,0.2);
        }

        .student-card.present {
            background: linear-gradient(145deg, #e3f2e4, #d3e9d5);
            border-color: var(--color-green);
            color: var(--color-green);
        }

        .student-card.absent {
            background: linear-gradient(145deg, #f9e2e2, #f1c7c7);
            border-color: var(--color-orange);
            color: var(--color-orange);
        }

        .student-card.on-leave {
            background: linear-gradient(145deg, #fefce7, #fdf8c9);
            border-color: var(--color-yellow);
            color: var(--color-yellow);
        }

        .student-name {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .student-status {
            font-size: 0.9em;
            padding: 5px 10px;
            border-radius: 15px;
            background: rgba(255,255,255,0.3);
            display: inline-block;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(145deg, #ffffff, #f0f0f0);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #333;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        input[type="text"], select, textarea {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            min-width: 200px;
        }

        input[type="text"]:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--color-green);
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            animation: slideDown 0.3s ease;
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes slideDown {
            from { transform: translateY(-50px) scale(0.95); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            z-index: 2000;
            transform: translateX(120%);
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: linear-gradient(45deg, var(--color-green), #45a049);
        }

        .notification.error {
            background: linear-gradient(45deg, var(--color-orange), #a74e3a);
        }
        
        h3 {
            margin-top: 20px;
            margin-bottom: 10px;
            color: var(--color-green);
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            white-space: nowrap;
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--color-green), #45a049);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(45deg, var(--color-yellow), #c09a47);
            color: white;
        }

        .btn-purple {
            background: linear-gradient(45deg, var(--color-blue), #4c7b8c);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(45deg, var(--color-orange), #a74e3a);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .results-list {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            word-break: break-word;
        }

        .results-list-present { background: rgba(76, 175, 80, 0.1); color: var(--color-green); }
        .results-list-absent { background: rgba(226, 100, 72, 0.1); color: var(--color-orange); }
        .results-list-on-leave { background: rgba(217, 172, 90, 0.1); color: var(--color-yellow); }

        .firebase-config {
            background: rgba(95, 143, 167, 0.1);
            border-left: 4px solid var(--color-blue);
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
        }

        .firebase-config textarea {
            width: 100%;
            height: 150px;
            font-family: monospace;
            font-size: 0.9em;
        }

        .connection-status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            margin-left: 10px;
        }

        .connected {
    /* 調整背景色，使其更為飽和 */
    background: #4CAF50; /* 直接使用綠色變數 */
    /* 讓文字顏色保持白色以增加對比 */
    color: white; 
    /* 增加陰影效果 */
    box-shadow: 0 2px 4px rgba(0, 100, 0, 0.2); 
}

/* 可以為滑鼠懸停時增加動畫效果 */
.connected:hover {
    transform: scale(1.05);
}

        .disconnected {
            background: rgba(226, 100, 72, 0.2);
            color: var(--color-orange);
        }

        .connecting {
            background: rgba(217, 172, 90, 0.2);
            color: var(--color-yellow);
        }

        @media (max-width: 768px) {
            body { padding: 10px; }
            .header h1 { font-size: 2em; }
            .student-grid { grid-template-columns: repeat(auto-fill, 200px); gap: 15px; }
            .input-group { flex-direction: column; }
            .header .btn-settings { position: static; margin-top: 10px; width: 40px; height: 40px; font-size: 1.2em; }
            .header-main-row { flex-direction: column; }
            .header-actions { flex-direction: column; }
            .modal-content { width: 95%; padding: 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-main-row">
                <h1>扶少點名系統</h1>
                <div class="week-info">
                    <span id="currentDate"></span>
                    <span id="connectionStatus" class="connection-status connecting">連接中...</span>
                </div>
            </div>

            <div class="header-actions">
                <button class="btn btn-warning" id="leaveModeBtn" onclick="toggleLeaveMode()">標記請假</button>
                <button class="btn btn-purple" onclick="showResults()">點名結果</button>
            </div>
            
            <button class="btn-settings" onclick="showModal('settingsModal')">⚙️</button>
        </div>
        
        <div class="content">
            <div class="student-grid" id="studentGrid">
                <p>正在連接雲端資料庫...</p>
            </div>
        </div>
        
        <div class="footer">
            ☁️ 雲端即時同步 | 所有裝置資料自動同步
        </div>
    </div>

    <!-- Firebase 設定模態框 -->
    <div id="configModal" class="modal">
        <div class="modal-content">
            <h2>🔥 Firebase 設定</h2>
            <p style="color: #666; margin-bottom: 15px;">
                請在下方貼上您的 Firebase 設定資訊。設定完成後，所有裝置的資料將會自動同步。
            </p>
            
            <div class="firebase-config">
                <h4>Firebase 設定 JSON</h4>
                <textarea id="firebaseConfig" placeholder='{
"apiKey": "your-api-key",
"authDomain": "your-project.firebaseapp.com",
"projectId": "your-project-id",
"storageBucket": "your-project.appspot.com",
"messagingSenderId": "123456789",
"appId": "your-app-id"
}'></textarea>
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button class="btn btn-primary" onclick="saveFirebaseConfig()">儲存設定</button>
                <button class="btn btn-danger" onclick="useOfflineMode()">離線模式</button>
            </div>
            
            <div style="margin-top: 20px; font-size: 0.9em; color: #666;">
                <h4>如何取得 Firebase 設定？</h4>
                <ol>
                    <li>到 <a href="https://console.firebase.google.com/" target="_blank">Firebase Console</a></li>
                    <li>建立新專案或選擇現有專案</li>
                    <li>啟用 Firestore 資料庫（測試模式）</li>
                    <li>到專案設定 → 應用程式 → 網頁應用程式</li>
                    <li>複製設定物件並貼到上方</li>
                </ol>
            </div>
        </div>
    </div>

    <!-- 設定模態框 -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('settingsModal')">&times;</span>
            <h2><i class="ph-fill ph-gear-six"></i> 設定</h2>
            <div class="settings-grid">
                <button class="btn btn-primary" onclick="showManagementModal()">學生管理</button>
                <button class="btn btn-purple" onclick="showModal('configModal')">Firebase 設定</button>
                <button class="btn btn-danger" onclick="resetAllData()">重設整個系統</button>
            </div>
        </div>
    </div>

    <!-- 學生管理模態框 -->
    <div id="managementModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('managementModal')">&times;</span>
            <h2><i class="ph-fill ph-users"></i> 學生管理</h2>
            
            <p style="color: #666; margin-bottom: 15px;">新增、移除或批量新增學生。所有更動將即時同步給團隊成員。</p>
            
            <div class="input-group">
                <input type="text" id="newStudentName" placeholder="輸入學生姓名">
                <button class="btn btn-primary" onclick="addStudent()">新增</button>
            </div>
            
            <h4 style="margin-top: 20px;">批量新增（每行一個姓名）</h4>
            <textarea id="bulkStudents" placeholder="張小明&#10;李小華&#10;王小美" style="width: 100%; height: 120px; padding: 10px; border: 2px solid #ddd; border-radius: 8px; margin-bottom: 10px;"></textarea>
            <button class="btn btn-primary" onclick="addBulkStudents()">批量新增</button>
            
            <h4 style="margin-top: 20px;">移除學生</h4>
            <div class="input-group">
                <select id="removeStudentSelect" style="flex: 1; min-width: 200px;">
                    <option value="">選擇要移除的學生</option>
                </select>
                <button class="btn btn-danger" onclick="removeStudent()">移除</button>
            </div>
        </div>
    </div>

    <!-- 點名結果模態框 -->
    <div id="resultsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('resultsModal')">&times;</span>
            <h2>📊 點名結果</h2>
            <div id="resultsContent"></div>
        </div>
    </div>

    <!-- 通知訊息 -->
    <div id="notification" class="notification"></div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, writeBatch, collection, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 全域變數 ---
        let students = [];
        let attendanceHistory = {};
        let leaveMode = false;
        let isOnline = false;
        let db = null;
        
        const currentDateKey = new Date().toISOString().split('T')[0];
        const STORAGE_KEY = 'attendanceSystem_firebaseConfig';

        // 預設的 Firebase 設定
        const defaultFirebaseConfig = {
            apiKey: "AIzaSyB4n7tnjJhyI9cmxpjnqbWMfrjDOYIrA3U",
            authDomain: "attendance-check-60081.firebaseapp.com",
            projectId: "attendance-check-60081",
            storageBucket: "attendance-check-60081.firebasestorage.app",
            messagingSenderId: "33068227665",
            appId: "1:33068227665:web:dba6f037b27c9aabc22c70",
            measurementId: "G-PLSZCJTTCF"
        };

        // --- Firebase 初始化 ---
        async function initFirebase() {
            let firebaseConfig = null;
            const savedConfig = localStorage.getItem(STORAGE_KEY);
            
            if (savedConfig) {
                try {
                    firebaseConfig = JSON.parse(savedConfig);
                } catch (error) {
                    console.error('解析儲存的設定失敗:', error);
                }
            }
            
            // 如果沒有儲存的設定，使用預設設定
            if (!firebaseConfig) {
                firebaseConfig = defaultFirebaseConfig;
                localStorage.setItem(STORAGE_KEY, JSON.stringify(firebaseConfig));
                showNotification('使用預設 Firebase 設定', 'success');
            }

            try {
                console.log('正在初始化 Firebase...', firebaseConfig.projectId);
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                
                // 測試連接並初始化資料
                await initializeData();
                setupRealtimeListeners();
                updateConnectionStatus('connected');
                showNotification('Firebase 連接成功！', 'success');
                return true;
            } catch (error) {
                console.error('Firebase 初始化失敗:', error);
                updateConnectionStatus('disconnected');
                showNotification(`連接失敗: ${error.message}`, 'error');
                loadOfflineData();
                return false;
            }
        }

        async function initializeData() {
            try {
                // 初始化學生名單
                const studentsRef = doc(db, 'attendance-system', 'students');
                const studentsSnap = await getDoc(studentsRef);
                
                if (!studentsSnap.exists()) {
                    console.log('初始化學生名單...');
                    await setDoc(studentsRef, { 
                        list: [],
                        created: new Date().toISOString(),
                        lastUpdated: new Date().toISOString()
                    });
                }

                // 初始化今日出勤記錄
                const attendanceRef = doc(db, 'attendance-system', currentDateKey);
                const attendanceSnap = await getDoc(attendanceRef);
                
                if (!attendanceSnap.exists()) {
                    console.log('初始化今日出勤記錄...');
                    await setDoc(attendanceRef, { 
                        records: {},
                        date: currentDateKey,
                        created: new Date().toISOString()
                    });
                }

                console.log('Firebase 資料初始化完成');
            } catch (error) {
                console.error('資料初始化失敗:', error);
                throw error;
            }
        }

        function setupRealtimeListeners() {
            console.log('設置即時監聽器...');
            
            // 監聽學生名單
            const studentsRef = doc(db, 'attendance-system', 'students');
            onSnapshot(studentsRef, (docSnap) => {
                console.log('學生名單更新');
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    students = data.list || [];
                } else {
                    students = [];
                }
                renderAll();
                updateRemoveStudentSelect();
            }, (error) => {
                console.error('學生名單監聽失敗:', error);
                updateConnectionStatus('disconnected');
                showNotification('同步中斷，切換到離線模式', 'error');
                loadOfflineData();
            });

            // 監聽今日出勤
            const attendanceRef = doc(db, 'attendance-system', currentDateKey);
            onSnapshot(attendanceRef, (docSnap) => {
                console.log('出勤記錄更新');
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    attendanceHistory[currentDateKey] = data.records || {};
                } else {
                    attendanceHistory[currentDateKey] = {};
                }
                renderAll();
            }, (error) => {
                console.error('出勤記錄監聽失敗:', error);
                updateConnectionStatus('disconnected');
                showNotification('同步中斷，切換到離線模式', 'error');
            });
        }

        // --- UI 函式 ---
        function updateConnectionStatus(status) {
            const statusElement = document.getElementById('connectionStatus');
            statusElement.className = `connection-status ${status}`;
            
            switch(status) {
                case 'connected':
                    statusElement.textContent = '☁️ 已連接';
                    isOnline = true;
                    break;
                case 'connecting':
                    statusElement.textContent = '🔄 連接中';
                    isOnline = false;
                    break;
                case 'disconnected':
                    statusElement.textContent = '❌ 離線';
                    isOnline = false;
                    break;
            }
        }

        window.saveFirebaseConfig = async () => {
            const configText = document.getElementById('firebaseConfig').value.trim();
            if (!configText) {
                showNotification('請輸入 Firebase 設定', 'error');
                return;
            }

            try {
                const config = JSON.parse(configText);
                if (!config.apiKey || !config.projectId) {
                    throw new Error('設定格式不正確');
                }
                
                localStorage.setItem(STORAGE_KEY, JSON.stringify(config));
                closeModal('configModal');
                showNotification('設定已儲存，正在連接...', 'success');
                
                // 重新載入頁面以套用新設定
                setTimeout(() => location.reload(), 1000);
            } catch (error) {
                showNotification('設定格式錯誤，請檢查 JSON 格式', 'error');
            }
        };

        window.useOfflineMode = () => {
            localStorage.removeItem(STORAGE_KEY);
            closeModal('configModal');
            showNotification('使用離線模式', 'success');
            loadOfflineData();
            renderAll();
        };

        // --- 資料操作函式 ---
        async function updateStudentList(newStudents) {
            if (isOnline) {
                try {
                    const studentsRef = doc(db, 'attendance-system', 'students');
                    await setDoc(studentsRef, { list: newStudents });
                } catch (error) {
                    console.error('更新學生名單失敗:', error);
                    showNotification('同步失敗', 'error');
                }
            } else {
                students = newStudents;
                saveOfflineData();
                renderAll();
                updateRemoveStudentSelect();
            }
        }

        async function updateAttendance(studentName, status) {
            if (isOnline) {
                try {
                    const attendanceRef = doc(db, 'attendance-system', currentDateKey);
                    const updateData = {};
                    
                    if (status === null) {
                        // 移除記錄
                        const currentData = attendanceHistory[currentDateKey] || {};
                        delete currentData[studentName];
                        await setDoc(attendanceRef, { records: currentData });
                    } else {
                        updateData[`records.${studentName}`] = status;
                        await updateDoc(attendanceRef, updateData);
                    }
                } catch (error) {
                    console.error('更新出勤記錄失敗:', error);
                    showNotification('同步失敗', 'error');
                }
            } else {
                if (status === null) {
                    delete attendanceHistory[currentDateKey][studentName];
                } else {
                    attendanceHistory[currentDateKey][studentName] = status;
                }
                saveOfflineData();
                renderAll();
            }
        }

        // --- 離線資料處理 ---
        function loadOfflineData() {
            const savedStudents = localStorage.getItem('offline_students');
            const savedAttendance = localStorage.getItem('offline_attendance');
            
            students = savedStudents ? JSON.parse(savedStudents) : [];
            attendanceHistory = savedAttendance ? JSON.parse(savedAttendance) : {};
            
            if (!attendanceHistory[currentDateKey]) {
                attendanceHistory[currentDateKey] = {};
            }

            // --- 新增：處理離線模式下的舊紀錄刪除 ---
            const twoDaysAgo = new Date();
            twoDaysAgo.setDate(twoDaysAgo.getDate() - 2);
            const twoDaysAgoStr = twoDaysAgo.toISOString().split('T')[0];

            for (const date in attendanceHistory) {
                if (date < twoDaysAgoStr) {
                    delete attendanceHistory[date];
                    console.log(`離線模式：已刪除過期記錄 ${date}`);
                }
            }
            saveOfflineData();
            // --- 結束新增 ---
            
            updateRemoveStudentSelect();
        }

        function saveOfflineData() {
            localStorage.setItem('offline_students', JSON.stringify(students));
            localStorage.setItem('offline_attendance', JSON.stringify(attendanceHistory));
        }

        // --- 主要功能函式 ---
        window.toggleAttendance = async (studentName) => {
            const attendance = getCurrentAttendance();
            let newStatus;
            
            if (leaveMode) {
                newStatus = attendance[studentName] === 'on-leave' ? null : 'on-leave';
            } else {
                if (attendance[studentName] === 'on-leave') {
                    showNotification(`${studentName} 已請假，無法點名`, 'error');
                    return;
                }
                newStatus = attendance[studentName] === 'present' ? null : 'present';
            }

            // 更新本地資料
            if (newStatus) {
                attendanceHistory[currentDateKey][studentName] = newStatus;
            } else {
                delete attendanceHistory[currentDateKey][studentName];
            }

            // 同步到雲端或儲存到本地
            await updateAttendance(studentName, newStatus);
            
            // 即時更新 UI
            if (!isOnline) {
                renderAll();
            }
        };

        window.toggleLeaveMode = () => {
            leaveMode = !leaveMode;
            const btn = document.getElementById('leaveModeBtn');
            if (leaveMode) {
                btn.textContent = '點名模式';
                btn.className = 'btn btn-primary';
                showNotification('已切換到請假模式', 'success');
            } else {
                btn.textContent = '標記請假';
                btn.className = 'btn btn-warning';
                showNotification('已切換到點名模式', 'success');
            }
        };

        window.addStudent = async () => {
            const nameInput = document.getElementById('newStudentName');
            const name = nameInput.value.trim();
            
            if (!name) {
                showNotification('請輸入學生姓名', 'error');
                return;
            }
            
            if (students.includes(name)) {
                showNotification('學生已存在', 'error');
                return;
            }
            
            const newStudents = [...students, name];
            await updateStudentList(newStudents);
            nameInput.value = '';
            showNotification(`已新增學生：${name}`, 'success');
        };

        window.addBulkStudents = async () => {
            const bulkText = document.getElementById('bulkStudents').value.trim();
            if (!bulkText) {
                showNotification('請輸入學生姓名', 'error');
                return;
            }
            
            const names = bulkText.split('\n').map(name => name.trim()).filter(name => name);
            const newNames = names.filter(name => !students.includes(name));
            
            if (newNames.length === 0) {
                showNotification('沒有新的學生需要新增', 'error');
                return;
            }
            
            const newStudents = [...students, ...newNames];
            await updateStudentList(newStudents);
            document.getElementById('bulkStudents').value = '';
            showNotification(`已批量新增 ${newNames.length} 名學生`, 'success');
        };

        window.removeStudent = async () => {
            const select = document.getElementById('removeStudentSelect');
            const studentName = select.value;
            
            if (!studentName) {
                showNotification('請選擇要移除的學生', 'error');
                return;
            }
            
            if (confirm(`確定要移除學生「${studentName}」嗎？`)) {
                const newStudents = students.filter(name => name !== studentName);
                await updateStudentList(newStudents);
                
                // 同時移除該學生的出勤記錄
                if (attendanceHistory[currentDateKey][studentName]) {
                    await updateAttendance(studentName, null);
                }
                
                showNotification(`已移除學生：${studentName}`, 'success');
            }
        };

        window.resetAttendance = async () => {
            if (confirm('確定要重置今日的點名記錄嗎？此操作無法復原！')) {
                attendanceHistory[currentDateKey] = {};
                
                if (isOnline) {
                    const attendanceRef = doc(db, 'attendance-system', currentDateKey);
                    await setDoc(attendanceRef, { records: {} });
                } else {
                    saveOfflineData();
                    renderAll();
                }
                
                showNotification('今日點名記錄已重置', 'success');
            }
        };

        // --- 新增的函式：重設所有資料 ---
        window.resetAllData = async () => {
            if (!confirm('🚨 警告：此操作將永久刪除所有學生名單及點名記錄！您確定要重設整個系統嗎？')) {
                return; // 如果使用者取消，則不做任何事
            }

            // 清除本地資料
            students = [];
            attendanceHistory = {};

            if (isOnline) {
                try {
                    const batch = writeBatch(db);
                    const attendanceCollection = collection(db, 'attendance-system');
                    const querySnapshot = await getDocs(attendanceCollection);
                    
                    querySnapshot.forEach((docSnap) => {
                        // 刪除所有 document，包括學生名單
                        const docRef = doc(db, 'attendance-system', docSnap.id);
                        batch.delete(docRef);
                    });
                    
                    await batch.commit();
                    showNotification('系統已重設！正在重新整理...', 'success');
                    // 等待 Firebase 同步，然後重新載入
                    setTimeout(() => location.reload(), 1500);

                } catch (error) {
                    console.error('重設資料時發生錯誤:', error);
                    showNotification('重設失敗，請檢查網路連線', 'error');
                }
            } else {
                // 離線模式
                saveOfflineData();
                showNotification('離線模式已重設所有資料！正在重新整理...', 'success');
                setTimeout(() => location.reload(), 1500);
            }
        };
        // --- 結束新增 ---

        // --- 輔助函式 ---
        function getCurrentAttendance() {
            return attendanceHistory[currentDateKey] || {};
        }

        function updateRemoveStudentSelect() {
            const select = document.getElementById('removeStudentSelect');
            select.innerHTML = '<option value="">選擇要移除的學生</option>';
            
            students.forEach(student => {
                const option = document.createElement('option');
                option.value = student;
                option.textContent = student;
                select.appendChild(option);
            });
        }

        function renderAll() {
            renderStudents();
            updateCurrentDate();
        }

        function renderStudents() {
            const grid = document.getElementById('studentGrid');
            const attendance = getCurrentAttendance();
            
            if (students.length === 0) {
                grid.innerHTML = '<p style="text-align: center; color: #666;">尚未新增任何學生，請到設定中新增學生。</p>';
                return;
            }
            
            grid.innerHTML = students.map(student => {
                const status = attendance[student] || 'not-marked';
                const statusText = {
                    'present': '✅ 出席',
                    'on-leave': '請假',
                    'not-marked': '❌ 未點名'
                };
                
                return `
                    <div class="student-card ${status}" onclick="toggleAttendance('${student}')">
                        <div class="student-name">${student}</div>
                        <div class="student-status">${statusText[status]}</div>
                    </div>
                `;
            }).join('');
        }

        function updateCurrentDate() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('zh-TW', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                weekday: 'long'
            });
            document.getElementById('currentDate').textContent = dateStr;
        }

        // --- 模態框函式 ---
        window.showModal = (modalId) => {
            document.getElementById(modalId).style.display = 'flex';
            
            if (modalId === 'managementModal') {
                updateRemoveStudentSelect();
            } else if (modalId === 'configModal') {
                const savedConfig = localStorage.getItem(STORAGE_KEY);
                if (savedConfig) {
                    document.getElementById('firebaseConfig').value = JSON.stringify(JSON.parse(savedConfig), null, 2);
                }
            }
        };

        window.closeModal = (modalId) => {
            document.getElementById(modalId).style.display = 'none';
        };

        window.showManagementModal = () => {
            closeModal('settingsModal');
            showModal('managementModal');
        };

        window.showResults = () => {
            const attendance = getCurrentAttendance();
            const present = students.filter(student => attendance[student] === 'present');
            const onLeave = students.filter(student => attendance[student] === 'on-leave');
            const absent = students.filter(student => !attendance[student] || attendance[student] === 'not-marked');
            
            const resultsContent = document.getElementById('resultsContent');
            resultsContent.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <strong>點名日期：</strong>${new Date().toLocaleDateString('zh-TW')}
                </div>
                
                <div class="results-list results-list-present">
                    <strong>出席 (${present.length}人)：</strong><br>
                    ${present.length > 0 ? present.join('、') : '無'}
                </div>
                
                <div class="results-list results-list-absent">
                    <strong>缺席 (${absent.length}人)：</strong><br>
                    ${absent.length > 0 ? absent.join('、') : '無'}
                </div>
                
                <div class="results-list results-list-on-leave">
                    <strong>請假 (${onLeave.length}人)：</strong><br>
                    ${onLeave.length > 0 ? onLeave.join('、') : '無'}
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 8px;">
                    <strong>統計摘要：</strong><br>
                    總人數：${students.length}人<br>
                    出席率：${students.length > 0 ? Math.round((present.length / students.length) * 100) : 0}%
                </div>
            `;
            
            showModal('resultsModal');
        };

        // --- 通知函式 ---
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            
            // 觸發顯示動畫
            setTimeout(() => notification.classList.add('show'), 100);
            
            // 3秒後隱藏
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // --- 新增函式：自動清除舊的點名記錄 ---
        async function cleanupOldAttendance() {
            console.log('正在檢查並清除舊的點名記錄...');
            const twoDaysAgo = new Date();
            twoDaysAgo.setDate(twoDaysAgo.getDate() - 2);
            const twoDaysAgoStr = twoDaysAgo.toISOString().split('T')[0];

            if (isOnline && db) {
                try {
                    const attendanceCollection = collection(db, 'attendance-system');
                    const querySnapshot = await getDocs(attendanceCollection);
                    const batch = writeBatch(db);
                    let deletedCount = 0;
                    
                    querySnapshot.forEach((docSnap) => {
                        // 排除學生名單 document
                        if (docSnap.id !== 'students') {
                            const docDate = docSnap.id;
                            if (docDate < twoDaysAgoStr) {
                                const docRef = doc(db, 'attendance-system', docDate);
                                batch.delete(docRef);
                                deletedCount++;
                                console.log(`Firebase：準備刪除過期記錄 ${docDate}`);
                            }
                        }
                    });
                    
                    if (deletedCount > 0) {
                        await batch.commit();
                        showNotification(`已自動清除 ${deletedCount} 筆過期點名記錄`, 'success');
                    }
                } catch (error) {
                    console.error('清除舊記錄時發生錯誤:', error);
                    showNotification('清除舊記錄失敗', 'error');
                }
            } else {
                // 離線模式的清理邏輯已在 loadOfflineData 函式中處理
                console.log('離線模式，記錄清理已在載入時完成');
            }
        }
        // --- 結束新增 ---

        // --- 事件監聽器 ---
        document.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const target = e.target;
                if (target.id === 'newStudentName') {
                    addStudent();
                }
            }
        });

        // 點擊模態框外部關閉
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                const modalId = e.target.id;
                if (modalId !== 'configModal') { // 配置模態框不允許點擊外部關閉
                    closeModal(modalId);
                }
            }
        });

        // --- 初始化 ---
        async function initialize() {
            console.log('系統初始化開始...');
            updateCurrentDate();
            updateConnectionStatus('connecting');
            
            try {
                const firebaseReady = await initFirebase();
                
                if (firebaseReady) {
                    // --- 在連接成功後，執行清理舊記錄的動作 ---
                    await cleanupOldAttendance();
                    // --- 結束新增 ---
                } else {
                    console.log('Firebase 連接失敗，載入離線資料');
                    loadOfflineData();
                }
                renderAll();
            } catch (error) {
                console.error('初始化錯誤:', error);
                updateConnectionStatus('disconnected');
                showNotification('初始化失敗，使用離線模式', 'error');
                loadOfflineData();
                renderAll();
            }
        }

        // 啟動應用
        initialize();
    </script>
</body>
</html>
